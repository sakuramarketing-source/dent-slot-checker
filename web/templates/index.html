{% extends "base.html" %}

{% block title %}ダッシュボード - 予約空き状況チェッカー{% endblock %}

{% block content %}
<h1>ダッシュボード</h1>

<div class="dashboard-actions">
    <button id="runCheckBtn" class="btn btn-primary">手動チェック実行</button>
    <span id="checkStatus" class="status-message"></span>
</div>

{% if result %}
<div class="result-summary">
    <h2>最新チェック結果</h2>
    <p class="check-info">
        <strong>チェック対象日:</strong> {{ result.check_date }}<br>
        <strong>チェック日時:</strong> {{ result.checked_at }}
    </p>

    <div class="summary-stats">
        <div class="stat-box">
            <span class="stat-value">{{ result.summary.total_clinics }}</span>
            <span class="stat-label">対象分院数</span>
        </div>
        <div class="stat-box">
            <span class="stat-value">{{ result.summary.clinics_with_availability }}</span>
            <span class="stat-label">空きあり分院</span>
        </div>
    </div>
</div>

<div class="results-grid">
    {% for clinic_result in result.results %}
    <div class="clinic-card {% if clinic_result.result %}has-availability{% else %}no-availability{% endif %}">
        <div class="clinic-header">
            <h3>{{ clinic_result.clinic }}</h3>
            <span class="status-badge {% if clinic_result.result %}ok{% else %}ng{% endif %}">
                {% if clinic_result.result %}OK{% else %}NG{% endif %}
            </span>
        </div>
        <div class="clinic-body">
            <p><strong>30分ブロック数:</strong> {{ clinic_result.total_30min_blocks }}</p>
            {% if clinic_result.details %}
            <details>
                <summary>詳細を見る</summary>
                <ul class="detail-list">
                    {% for detail in clinic_result.details %}
                    <li>
                        <strong>{{ detail.doctor }}</strong>: {{ detail.blocks }}ブロック
                        <ul>
                            {% for time in detail.times %}
                            <li>{{ time }}</li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
            </details>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="no-results">
    <p>チェック結果がありません。「手動チェック実行」ボタンをクリックしてチェックを実行してください。</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.getElementById('runCheckBtn').addEventListener('click', async function() {
    const btn = this;
    const status = document.getElementById('checkStatus');

    btn.disabled = true;
    btn.textContent = 'チェック中...';
    status.textContent = 'タスクを開始中...';
    status.className = 'status-message progress';

    try {
        // 1. タスク開始
        const startResponse = await fetch('/api/results/check-start', {
            method: 'POST'
        });

        if (!startResponse.ok) {
            throw new Error('Failed to start task');
        }

        const startData = await startResponse.json();
        const taskId = startData.task_id;

        // 2. ポーリングで進捗監視（2秒間隔）
        let completed = false;
        while (!completed) {
            await new Promise(resolve => setTimeout(resolve, 2000));

            const statusResponse = await fetch(`/api/results/check-status/${taskId}`);

            if (!statusResponse.ok) {
                throw new Error('Failed to get task status');
            }

            const taskStatus = await statusResponse.json();

            if (taskStatus.status === 'running' && taskStatus.progress) {
                const p = taskStatus.progress;
                status.textContent = `${p.current_clinic} をチェック中... (${p.current}/${p.total})`;
                status.className = 'status-message progress';
            } else if (taskStatus.status === 'completed') {
                completed = true;
                const summary = taskStatus.result?.summary || {};
                status.textContent = `チェック完了！ ${summary.clinics_with_availability || 0}/${summary.total_clinics || 0} 分院で空きあり`;
                status.className = 'status-message success';
                setTimeout(() => location.reload(), 2500);  // 2.5秒後にリロード
            } else if (taskStatus.status === 'failed') {
                completed = true;
                status.textContent = 'エラー: ' + (taskStatus.error || '不明なエラー');
                status.className = 'status-message error';
                btn.disabled = false;
                btn.textContent = '手動チェック実行';
            }
        }
    } catch (error) {
        status.textContent = 'エラー: ' + error.message;
        status.className = 'status-message error';
        btn.disabled = false;
        btn.textContent = '手動チェック実行';
    }
});
</script>
{% endblock %}
