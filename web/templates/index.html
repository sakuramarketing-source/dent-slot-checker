{% extends "base.html" %}

{% block title %}ダッシュボード - 予約空き状況チェッカー{% endblock %}

{% block content %}
<h1>ダッシュボード</h1>

<div class="dashboard-actions">
    <button id="runCheckBtn" class="btn btn-primary">手動チェック実行</button>
    <span id="checkStatus" class="status-message"></span>
</div>

{% if result %}
<div class="result-summary">
    <h2>最新チェック結果
        <span class="category-filter" id="categoryFilter">
            <button class="category-filter-btn active" data-filter="all">全て</button>
            <button class="category-filter-btn" data-filter="doctor">Dr</button>
            <button class="category-filter-btn" data-filter="hygienist">DH</button>
        </span>
    </h2>
    <p class="check-info">
        <strong>チェック対象日:</strong> {{ result.check_date }}<br>
        <strong>チェック日時:</strong> {{ result.checked_at }}
    </p>

    <div class="summary-stats">
        <div class="stat-box">
            <span class="stat-value">{{ result.summary.total_clinics }}</span>
            <span class="stat-label">対象分院数</span>
        </div>
        <div class="stat-box">
            <span class="stat-value">{{ result.summary.clinics_with_availability }}</span>
            <span class="stat-label">空きあり分院</span>
        </div>
    </div>
    <p style="font-size:0.8rem;color:#e67e22;margin-top:0.5rem">* WEB予約受付スタッフのみで集計（<a href="/staff">スタッフ管理</a>で設定）</p>
</div>

<div class="results-grid">
    {% for clinic_result in result.results %}
    <div class="clinic-card {% if clinic_result.result %}has-availability{% else %}no-availability{% endif %}">
        <div class="clinic-header">
            <h3>{{ clinic_result.clinic }}</h3>
            <span class="status-badge {% if clinic_result.result %}ok{% else %}ng{% endif %}">
                {% if clinic_result.result %}OK{% else %}NG{% endif %}
            </span>
        </div>
        <div class="clinic-body">
            {% set th = clinic_result.get('slot_threshold', {}) %}
            {% set dr_th = th.get('doctor', 30) %}
            {% set dh_th = th.get('hygienist', 30) %}
            {% if dr_th == dh_th %}
            <p><strong>{{ dr_th }}分空き枠数:</strong> {{ clinic_result.total_30min_blocks }}</p>
            {% else %}
            <p><strong>空き枠数:</strong> {{ clinic_result.total_30min_blocks }} <span style="font-size:0.75rem;color:#7f8c8d">(Dr:{{ dr_th }}分/DH:{{ dh_th }}分)</span></p>
            {% endif %}
            {% if clinic_result.details %}
            {% set clinic_idx = loop.index %}
            <div class="clinic-timeline" id="clinic-tl-{{ clinic_idx }}"></div>
            <details>
                <summary>詳細を見る</summary>
                <div class="detail-list">
                    {% for detail in clinic_result.details %}
                    <div class="staff-detail-item">
                        <div class="staff-detail-header">
                            <span class="staff-category-badge {{ detail.category or 'unknown' }}">{{ 'Dr' if detail.category == 'doctor' else ('DH' if detail.category == 'hygienist' else '--') }}</span>
                            <strong>{{ detail.doctor }}</strong>
                            <span style="color:#7f8c8d">{{ detail.blocks }}枠{% if detail.get('threshold_minutes', 30) != 30 %}({{ detail.threshold_minutes }}分){% endif %}</span>
                        </div>
                        <div class="time-tags">
                            {% for t in detail.times %}
                            <span class="time-tag {{ detail.category or 'unknown' }}">{{ t }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="no-results">
    <p>チェック結果がありません。「手動チェック実行」ボタンをクリックしてチェックを実行してください。</p>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// タイムライン描画 + カテゴリフィルタ
(function() {
    const clinicData = {{ result.results | tojson if result else '[]' }};
    const minBlocks = {{ min_blocks | default(4) }};
    let currentFilter = 'all';

    // 初期タイムライン描画
    renderTimelines(clinicData, 'all');

    // フィルタボタンのクリックイベント
    const filterEl = document.getElementById('categoryFilter');
    if (filterEl) {
        filterEl.addEventListener('click', function(e) {
            const btn = e.target.closest('.category-filter-btn');
            if (!btn) return;

            this.querySelectorAll('.category-filter-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            applyFilter(currentFilter);
        });
    }

    function renderTimelines(data, filter) {
        data.forEach(function(clinic, ci) {
            const el = document.getElementById('clinic-tl-' + (ci + 1));
            if (el && clinic.details) {
                const details = (filter === 'all')
                    ? clinic.details
                    : clinic.details.filter(function(d) { return d.category === filter; });
                el.innerHTML = details.length > 0 ? buildClinicTimelineHTML(details) : '';
            }
        });
    }

    function applyFilter(filter) {
        const cards = document.querySelectorAll('.clinic-card');
        let clinicsWithAvailability = 0;

        cards.forEach(function(card, ci) {
            const clinic = clinicData[ci];
            if (!clinic) return;

            // スタッフ詳細のshow/hide
            const staffItems = card.querySelectorAll('.staff-detail-item');
            let filteredBlocks = 0;
            let visibleCount = 0;

            (clinic.details || []).forEach(function(detail, di) {
                var item = staffItems[di];
                if (!item) return;
                var match = (filter === 'all') || (detail.category === filter);
                item.style.display = match ? '' : 'none';
                if (match) {
                    filteredBlocks += detail.blocks;
                    visibleCount++;
                }
            });

            // 空き枠数を更新
            var blockEl = card.querySelector('.clinic-body > p');
            if (blockEl) {
                var th = clinic.slot_threshold || {};
                var drTh = th.doctor || 30;
                var dhTh = th.hygienist || 30;
                var label;
                if (filter === 'doctor') {
                    label = drTh + '\u5206\u7a7a\u304d\u67a0\u6570';
                } else if (filter === 'hygienist') {
                    label = dhTh + '\u5206\u7a7a\u304d\u67a0\u6570';
                } else if (drTh === dhTh) {
                    label = drTh + '\u5206\u7a7a\u304d\u67a0\u6570';
                } else {
                    label = '\u7a7a\u304d\u67a0\u6570';
                }
                blockEl.innerHTML = '<strong>' + label + ':</strong> ' + filteredBlocks;
            }

            // 該当なしのカードを非表示
            var isAvailable = filteredBlocks >= minBlocks;
            if (filter !== 'all' && visibleCount === 0) {
                card.style.display = 'none';
            } else {
                card.style.display = '';
                // ステータスバッジを更新
                card.className = 'clinic-card ' + (isAvailable ? 'has-availability' : 'no-availability');
                var badge = card.querySelector('.status-badge');
                if (badge) {
                    badge.className = 'status-badge ' + (isAvailable ? 'ok' : 'ng');
                    badge.textContent = isAvailable ? 'OK' : 'NG';
                }
            }

            if (isAvailable && card.style.display !== 'none') {
                clinicsWithAvailability++;
            }
        });

        // サマリー統計を更新
        var statValues = document.querySelectorAll('.stat-value');
        if (statValues.length >= 2) {
            statValues[1].textContent = clinicsWithAvailability;
        }

        // タイムラインを再描画
        renderTimelines(clinicData, filter);
    }
})();

document.getElementById('runCheckBtn').addEventListener('click', async function() {
    const btn = this;
    const status = document.getElementById('checkStatus');

    btn.disabled = true;
    btn.textContent = 'チェック中...';
    status.textContent = '';
    status.className = 'status-message';

    try {
        const response = await fetch('/api/results/check', {
            method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
            status.textContent = 'チェック完了！ページを更新します...';
            status.classList.add('success');
            setTimeout(() => location.reload(), 1500);
        } else {
            status.textContent = 'エラー: ' + (data.message || 'チェック失敗');
            status.classList.add('error');
            btn.disabled = false;
            btn.textContent = '手動チェック実行';
        }
    } catch (error) {
        status.textContent = 'エラー: ' + error.message;
        status.classList.add('error');
        btn.disabled = false;
        btn.textContent = '手動チェック実行';
    }
});
</script>
{% endblock %}
