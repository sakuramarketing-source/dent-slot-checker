{% extends "base.html" %}

{% block title %}スタッフ管理 - 予約空き状況チェッカー{% endblock %}

{% block content %}
<h1>スタッフ管理</h1>
<p class="page-description">各スタッフの有効/無効と職種（Dr: ドクター / DH: 歯科衛生士）を設定します。無効にしたスタッフはチェック対象から除外されます。</p>
<p class="page-description" style="margin-top:4px;color:#e67e22"><strong>WEB受付</strong>: ONのスタッフのみ空き枠集計に含まれます。未設定の分院は全スタッフ対象。</p>

<div class="staff-actions">
    <button id="syncBtn" class="btn btn-primary" onclick="syncStaff()">
        <span class="btn-text">スタッフ同期</span>
        <span class="btn-loading" style="display:none;">同期中...</span>
    </button>
    <span id="syncStatus" class="status-message"></span>
</div>

<div id="staffContainer" class="staff-container">
    <div class="loading">読み込み中...</div>
</div>

{% endblock %}

{% block scripts %}
<script>
async function safeJson(response) {
    if (!response.ok) {
        throw new Error(`サーバーエラー (${response.status})`);
    }
    return response.json();
}

function toggleAccordion(header) {
    const body = header.nextElementSibling;
    const arrow = header.querySelector('.accordion-arrow');
    if (body.style.display === 'none') {
        body.style.display = '';
        arrow.classList.add('open');
    } else {
        body.style.display = 'none';
        arrow.classList.remove('open');
    }
}

async function loadStaff() {
    const container = document.getElementById('staffContainer');

    try {
        const response = await fetch('/api/staff/');
        const data = await safeJson(response);

        if (Object.keys(data).length === 0) {
            container.innerHTML = '<div class="no-data">スタッフデータがありません。先にチェックを実行してください。</div>';
            return;
        }

        let html = '';
        for (const [clinicName, clinicData] of Object.entries(data)) {
            const staffCount = clinicData.staff.length;

            html += `
                <div class="clinic-accordion">
                    <div class="clinic-accordion-header" onclick="toggleAccordion(this)">
                        <span class="accordion-arrow">&#9654;</span>
                        <h2>${clinicName}</h2>
                        <span class="staff-count">${staffCount > 0 ? staffCount + '名' : '未登録'}</span>
                    </div>
                    <div class="clinic-accordion-body" style="display:none;">
            `;

            // 閾値設定UI
            const threshold = clinicData.slot_threshold || {doctor: 30, hygienist: 30, orthodontist: 30};
            html += `
                <div class="threshold-settings" data-clinic="${clinicName}">
                    <span class="threshold-label">初診枠:</span>
                    <span class="threshold-group">
                        <span class="threshold-cat doctor">Dr</span>
                        <input type="number" class="threshold-input" value="${threshold.doctor}" min="10" max="120" step="5"
                            data-type="doctor" onchange="updateThreshold(this, '${clinicName}')">
                        <span class="threshold-unit">分</span>
                    </span>
                    <span class="threshold-group">
                        <span class="threshold-cat hygienist">DH</span>
                        <input type="number" class="threshold-input" value="${threshold.hygienist}" min="10" max="120" step="5"
                            data-type="hygienist" onchange="updateThreshold(this, '${clinicName}')">
                        <span class="threshold-unit">分</span>
                    </span>
                    <span class="threshold-group">
                        <span class="threshold-cat orthodontist">矯正</span>
                        <input type="number" class="threshold-input" value="${threshold.orthodontist || 30}" min="10" max="120" step="5"
                            data-type="orthodontist" onchange="updateThreshold(this, '${clinicName}')">
                        <span class="threshold-unit">分</span>
                    </span>
                </div>
            `;

            if (staffCount === 0) {
                html += '<p class="no-staff-message">スタッフ未登録（スタッフ同期またはチェック実行で追加されます）</p>';
            } else {
                html += '<div class="staff-list">';
                for (const staff of clinicData.staff) {
                    const isDisabled = !staff.enabled;
                    const isAutoDisabled = staff.auto_disabled;
                    const tagsHtml = (staff.tags || []).map(tag =>
                        `<span class="staff-tag">${tag}<button class="tag-remove" onclick="removeTag(this, '${clinicName}', '${staff.name}', '${tag}')">&times;</button></span>`
                    ).join('');

                    html += `
                        <div class="staff-item ${isDisabled ? 'disabled' : ''}" data-clinic="${clinicName}" data-name="${staff.name}">
                            <div class="staff-row-main">
                                <label class="toggle-switch ${isAutoDisabled ? 'auto-disabled' : ''}">
                                    <input type="checkbox" ${staff.enabled ? 'checked' : ''} ${isAutoDisabled ? 'disabled' : ''} onchange="handleToggle(this)">
                                    <span class="toggle-slider"></span>
                                </label>
                                <label class="web-booking-toggle ${isDisabled ? 'disabled-toggle' : ''}" title="WEB予約受付">
                                    <input type="checkbox" ${staff.web_booking ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} onchange="handleWebBookingToggle(this)">
                                    <span class="web-booking-label ${staff.web_booking ? 'active' : ''}">WEB</span>
                                </label>
                                <span class="staff-name">${staff.name}</span>
                                ${isAutoDisabled ? '<span class="auto-tag">自動除外</span>' : ''}
                                <div class="category-buttons">
                                    <button class="cat-btn ${(staff.categories || []).includes('doctor') ? 'active' : ''}" data-category="doctor" ${isDisabled ? 'disabled' : ''}>Dr</button>
                                    <button class="cat-btn ${(staff.categories || []).includes('hygienist') ? 'active' : ''}" data-category="hygienist" ${isDisabled ? 'disabled' : ''}>DH</button>
                                    <button class="cat-btn ${(staff.categories || []).includes('orthodontist') ? 'active' : ''}" data-category="orthodontist" ${isDisabled ? 'disabled' : ''}>矯正</button>
                                </div>
                                <div class="memo-input">
                                    <input type="text" class="memo-field" placeholder="メモ" value="${staff.memo || ''}"
                                        onchange="updateMemo(this, '${clinicName}', '${staff.name}')" ${isDisabled ? 'disabled' : ''}>
                                </div>
                            </div>
                            <div class="staff-row-tags">
                                <div class="tags-container">
                                    ${tagsHtml}
                                    <button class="tag-add-btn" onclick="showTagInput(this)" ${isDisabled ? 'disabled' : ''}>+ タグ</button>
                                    <input type="text" class="tag-input" placeholder="タグを入力" style="display:none;"
                                        onkeydown="handleTagInput(event, this, '${clinicName}', '${staff.name}')"
                                        onblur="hideTagInput(this)">
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
            }

            html += `
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;

        // イベントリスナーを追加
        document.querySelectorAll('.cat-btn').forEach(btn => {
            btn.addEventListener('click', handleCategoryClick);
        });

    } catch (error) {
        container.innerHTML = `<div class="error">エラー: ${error.message}</div>`;
    }
}

async function handleToggle(checkbox) {
    const staffItem = checkbox.closest('.staff-item');
    const clinic = staffItem.dataset.clinic;
    const name = staffItem.dataset.name;

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}/toggle`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name })
        });

        const data = await safeJson(response);

        if (data.success) {
            // UI更新
            if (data.enabled) {
                staffItem.classList.remove('disabled');
                staffItem.querySelectorAll('.cat-btn').forEach(btn => btn.disabled = false);
            } else {
                staffItem.classList.add('disabled');
                staffItem.querySelectorAll('.cat-btn').forEach(btn => btn.disabled = true);
            }
        } else {
            alert('保存に失敗しました: ' + (data.error || ''));
            checkbox.checked = !checkbox.checked;
        }
    } catch (error) {
        alert('エラー: ' + error.message);
        checkbox.checked = !checkbox.checked;
    }
}

async function handleWebBookingToggle(checkbox) {
    const staffItem = checkbox.closest('.staff-item');
    const clinic = staffItem.dataset.clinic;
    const name = staffItem.dataset.name;
    const label = checkbox.nextElementSibling;

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}/web-booking`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        const data = await safeJson(response);

        if (data.success) {
            if (data.web_booking) {
                label.classList.add('active');
            } else {
                label.classList.remove('active');
            }
        } else {
            alert('保存に失敗しました: ' + (data.error || ''));
            checkbox.checked = !checkbox.checked;
        }
    } catch (error) {
        alert('エラー: ' + error.message);
        checkbox.checked = !checkbox.checked;
    }
}

async function handleCategoryClick(event) {
    const btn = event.target;
    if (btn.disabled) return;

    const staffItem = btn.closest('.staff-item');
    const clinic = staffItem.dataset.clinic;
    const name = staffItem.dataset.name;

    // トグル方式: クリックしたボタンのactive状態を切り替え
    btn.classList.toggle('active');

    // 現在アクティブな全カテゴリを取得
    const activeCategories = [...staffItem.querySelectorAll('.cat-btn.active')]
        .map(b => b.dataset.category);

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name, categories: activeCategories })
        });

        const data = await safeJson(response);

        if (!data.success) {
            alert('保存に失敗しました: ' + (data.error || ''));
        }
    } catch (error) {
        alert('エラー: ' + error.message);
    }
}

async function syncStaff() {
    const btn = document.getElementById('syncBtn');
    const btnText = btn.querySelector('.btn-text');
    const btnLoading = btn.querySelector('.btn-loading');
    const statusEl = document.getElementById('syncStatus');

    // ボタンを無効化
    btn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    statusEl.textContent = '各分院のスタッフ情報を取得中...';
    statusEl.className = 'status-message';

    try {
        const response = await fetch('/api/staff/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await safeJson(response);

        if (data.success) {
            statusEl.textContent = data.message;
            statusEl.className = 'status-message success';

            // 取得件数を表示
            const counts = Object.entries(data.results)
                .map(([clinic, count]) => `${clinic}: ${count}名`)
                .join(', ');
            statusEl.textContent += ` (${counts})`;

            // スタッフ一覧を再読み込み
            await loadStaff();
        } else {
            statusEl.textContent = 'エラー: ' + data.message;
            statusEl.className = 'status-message error';
        }
    } catch (error) {
        statusEl.textContent = 'エラー: ' + error.message;
        statusEl.className = 'status-message error';
    } finally {
        // ボタンを有効化
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
    }
}

// メモ更新
async function updateMemo(input, clinic, name) {
    const memo = input.value.trim();

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}/memo`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, memo })
        });

        const data = await safeJson(response);
        if (!data.success) {
            alert('メモの保存に失敗しました');
        }
    } catch (error) {
        alert('エラー: ' + error.message);
    }
}

// タグ入力欄を表示
function showTagInput(btn) {
    const input = btn.nextElementSibling;
    btn.style.display = 'none';
    input.style.display = 'inline-block';
    input.focus();
}

// タグ入力欄を非表示
function hideTagInput(input) {
    setTimeout(() => {
        input.style.display = 'none';
        input.value = '';
        input.previousElementSibling.style.display = 'inline-block';
    }, 100);
}

// タグ入力処理
async function handleTagInput(event, input, clinic, name) {
    if (event.key !== 'Enter') return;

    const tag = input.value.trim();
    if (!tag) return;

    const staffItem = input.closest('.staff-item');
    const currentTags = Array.from(staffItem.querySelectorAll('.staff-tag'))
        .map(el => el.textContent.replace('×', '').trim());

    if (currentTags.includes(tag)) {
        alert('このタグは既に存在します');
        return;
    }

    const newTags = [...currentTags, tag];

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, tags: newTags })
        });

        const data = await safeJson(response);
        if (data.success) {
            // UIを更新
            const tagsContainer = input.closest('.tags-container');
            const addBtn = tagsContainer.querySelector('.tag-add-btn');
            const newTagEl = document.createElement('span');
            newTagEl.className = 'staff-tag';
            newTagEl.innerHTML = `${tag}<button class="tag-remove" onclick="removeTag(this, '${clinic}', '${name}', '${tag}')">&times;</button>`;
            tagsContainer.insertBefore(newTagEl, addBtn);

            input.value = '';
            hideTagInput(input);
        } else {
            alert('タグの保存に失敗しました');
        }
    } catch (error) {
        alert('エラー: ' + error.message);
    }
}

// タグ削除
async function removeTag(btn, clinic, name, tagToRemove) {
    const staffItem = btn.closest('.staff-item');
    const currentTags = Array.from(staffItem.querySelectorAll('.staff-tag'))
        .map(el => el.textContent.replace('×', '').trim());

    const newTags = currentTags.filter(t => t !== tagToRemove);

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}/tags`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, tags: newTags })
        });

        const data = await safeJson(response);
        if (data.success) {
            btn.closest('.staff-tag').remove();
        } else {
            alert('タグの削除に失敗しました');
        }
    } catch (error) {
        alert('エラー: ' + error.message);
    }
}

// 閾値更新
async function updateThreshold(input, clinic) {
    const type = input.dataset.type;
    const value = parseInt(input.value);

    if (isNaN(value) || value < 10 || value > 120) {
        alert('10〜120の範囲で入力してください');
        return;
    }

    const payload = {};
    payload[type] = value;

    try {
        const response = await fetch(`/api/staff/${encodeURIComponent(clinic)}/threshold`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await safeJson(response);
        if (data.success) {
            input.style.borderColor = '#27ae60';
            setTimeout(() => { input.style.borderColor = ''; }, 1500);
        } else {
            alert('保存に失敗しました');
        }
    } catch (error) {
        alert('エラー: ' + error.message);
    }
}

// ページ読み込み時にスタッフを取得
loadStaff();
</script>
{% endblock %}
