{% extends "base.html" %}

{% block title %}結果一覧 - 予約空き状況チェッカー{% endblock %}

{% block content %}
<h1>結果一覧</h1>
<p class="page-description">過去のチェック結果を確認できます。</p>

<div class="results-controls">
    <label for="dateSelect">日付を選択:</label>
    <select id="dateSelect">
        <option value="">読み込み中...</option>
    </select>
    <span class="category-filter" id="categoryFilter">
        <button class="category-filter-btn active" data-filter="all">全て</button>
        <button class="category-filter-btn" data-filter="doctor">Dr</button>
        <button class="category-filter-btn" data-filter="hygienist">DH</button>
    </span>
</div>

<div id="resultsContainer" class="results-detail-container">
    <div class="loading">読み込み中...</div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentResultData = null;
let currentCategoryFilter = 'all';

// フィルタボタンのクリックイベント
document.getElementById('categoryFilter').addEventListener('click', function(e) {
    const btn = e.target.closest('.category-filter-btn');
    if (!btn) return;

    this.querySelectorAll('.category-filter-btn').forEach(function(b) { b.classList.remove('active'); });
    btn.classList.add('active');
    currentCategoryFilter = btn.dataset.filter;

    if (currentResultData) {
        renderResult(currentResultData, currentCategoryFilter);
    }
});

async function loadResultList() {
    const select = document.getElementById('dateSelect');

    try {
        const response = await fetch('/api/results/list');
        const data = await response.json();

        if (data.length === 0) {
            select.innerHTML = '<option value="">結果がありません</option>';
            document.getElementById('resultsContainer').innerHTML = '<div class="no-data">結果がありません</div>';
            return;
        }

        select.innerHTML = data.map(item =>
            `<option value="${item.check_date}">${item.check_date}</option>`
        ).join('');

        loadResultByDate(data[0].check_date);

        select.addEventListener('change', function() {
            loadResultByDate(this.value);
        });

    } catch (error) {
        select.innerHTML = '<option value="">エラー</option>';
        document.getElementById('resultsContainer').innerHTML = `<div class="error">エラー: ${error.message}</div>`;
    }
}

async function loadResultByDate(date) {
    const container = document.getElementById('resultsContainer');
    container.innerHTML = '<div class="loading">読み込み中...</div>';

    try {
        const response = await fetch('/api/results/with-categories');
        const data = await response.json();

        if (data.error) {
            container.innerHTML = `<div class="error">${data.error}</div>`;
            return;
        }

        currentResultData = data;
        renderResult(data, currentCategoryFilter);

    } catch (error) {
        container.innerHTML = `<div class="error">エラー: ${error.message}</div>`;
    }
}

function renderResult(data, filter) {
    const container = document.getElementById('resultsContainer');
    const minBlocks = 4;

    let clinicsWithAvailability = 0;
    let visibleClinics = 0;

    let cardsHtml = '';

    for (const result of data.results) {
        const filteredDetails = (filter === 'all')
            ? result.details
            : (result.details || []).filter(function(d) { return d.category === filter; });

        if (filter !== 'all' && filteredDetails.length === 0) continue;

        visibleClinics++;
        const filteredBlocks = filteredDetails.reduce(function(sum, d) { return sum + d.blocks; }, 0);
        const isAvailable = filteredBlocks >= minBlocks;
        if (isAvailable) clinicsWithAvailability++;

        // カテゴリ集計
        const catSummary = {};
        filteredDetails.forEach(function(d) {
            var cat = d.category || 'unknown';
            catSummary[cat] = (catSummary[cat] || 0) + d.blocks;
        });

        cardsHtml += `
            <div class="clinic-card ${isAvailable ? 'has-availability' : 'no-availability'}">
                <div class="clinic-header">
                    <h3>${result.clinic}</h3>
                    <span class="status-badge ${isAvailable ? 'ok' : 'ng'}">
                        ${isAvailable ? '不足' : '充足'}
                    </span>
                </div>
                <div class="clinic-body">
                    <p><strong>30分空き枠数:</strong> ${filteredBlocks}</p>
                    ${(catSummary.doctor || catSummary.hygienist) ? `
                        <div class="category-summary">
                            ${catSummary.doctor ? '<span class="cat-stat doctor">Dr: ' + catSummary.doctor + '</span>' : ''}
                            ${catSummary.hygienist ? '<span class="cat-stat hygienist">DH: ' + catSummary.hygienist + '</span>' : ''}
                            ${catSummary.unknown ? '<span class="cat-stat other">他: ' + catSummary.unknown + '</span>' : ''}
                        </div>
                    ` : ''}
                    ${filteredDetails.length > 0 ? `
                        ${buildClinicTimelineHTML(filteredDetails)}
                        <details>
                            <summary>詳細を見る</summary>
                            <div class="detail-list">
                                ${filteredDetails.map(function(detail) { return `
                                    <div class="staff-detail-item">
                                        <div class="staff-detail-header">
                                            <span class="staff-category-badge ${detail.category || 'unknown'}">${getCategoryLabel(detail.category)}</span>
                                            <strong>${detail.doctor}</strong>
                                            <span style="color:#7f8c8d">${detail.blocks}枠</span>
                                            ${detail.memo ? '<span class="staff-memo">(' + detail.memo + ')</span>' : ''}
                                        </div>
                                        ${buildTimeTagsHTML(detail.times, detail.category || 'unknown')}
                                    </div>
                                `; }).join('')}
                            </div>
                        </details>
                    ` : ''}
                </div>
            </div>
        `;
    }

    let html = `
        <div class="result-header">
            <p><strong>チェック対象日:</strong> ${data.check_date}</p>
            <p><strong>チェック日時:</strong> ${data.checked_at}</p>
        </div>
        <div class="summary-stats">
            <div class="stat-box">
                <span class="stat-value">${filter === 'all' ? data.summary.total_clinics : visibleClinics}</span>
                <span class="stat-label">対象分院数</span>
            </div>
            <div class="stat-box">
                <span class="stat-value">${clinicsWithAvailability}</span>
                <span class="stat-label">不足分院</span>
            </div>
        </div>
        <p style="font-size:0.8rem;color:#e67e22;margin-top:0.5rem">* WEB予約受付スタッフのみで集計（<a href="/staff">スタッフ管理</a>で設定）</p>
        <div class="results-grid">
            ${cardsHtml}
        </div>
    `;

    container.innerHTML = html;
}

function getCategoryLabel(category) {
    switch(category) {
        case 'doctor': return 'Dr';
        case 'hygienist': return 'DH';
        default: return '--';
    }
}

loadResultList();
</script>
{% endblock %}
